-------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  C:\Users\Max\Dropbox\Seminar SS22\Exercise\Exercise 2\STATA\Exercise2.log
  log type:  text
 opened on:  10 Jun 2022, 13:42:20

. 
. cd "C:\Users\Max\Dropbox\Seminar SS22\Exercise\Exercise 2\STATA"
C:\Users\Max\Dropbox\Seminar SS22\Exercise\Exercise 2\STATA

. use dataset_2

. 
. 
. /********************************************************************
> 1. First stage and reduced form
> 2. OLS & 2 SLS
> 3. Tests
> 4. Multiple instruments --> Precision
> 
> ********************************************************************/
. 
. /*JOSHUA D. ANGRIST AND ALAN B. KRUEGER (1991)
> 
> Compulsory schooling laws:
> Quarter of birth as an instrumental variable of years of education
> Students born earlier in the year are old for their grade and thus have completed 
> less years of schooling when reaching the compulsory age for schooling
> 
> Question: Does this cause earlier dropouts? Therefore less education and less wages?
> 
> Problem: Endogeneity problem --> effects of education on earnings biased by OVB --> ability bias, motivation etc.
>  --> Educ correlated with error term
> 
> Assumptions: 
> 1. Relevance Assumption: QOB is related to Education
> 2. Independence Assumption: Quarter of birth is unrelated to innate ability, motivation or family background --> 
> want to use variation in educ, that is not correlated with Error term
> 3. Exclusion Restriction: The only way QOB affects our wages is through education
> 
> Remember: Z: Quarter of birth, X: Education, Y: Wages
> 
> We estimate the impact of compulsory schooling on earnings by using quarter of birth as an instrument for educati
> on
> 
> */
. 
. 
. 
. ****************************************************************************************
. *** 1. FIRST STAGE & REDUCED FORM
. 
. *** i. First stage: Effect of Z on X --> Relevance
. 
. *Create dummy variables for quarter of birth
. tab QOB, gen(QOB_)            

        QOB |      Freq.     Percent        Cum.
------------+-----------------------------------
          1 |     62,628       25.34       25.34
          2 |     60,888       24.63       49.97
          3 |     64,088       25.93       75.89
          4 |     59,595       24.11      100.00
------------+-----------------------------------
      Total |    247,199      100.00

. 
. *Regress QOB and Years on Education
. reg EDUC QOB_1-QOB_3 YR20-YR28

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(12, 247186)   =     46.35
       Model |  6268.13174        12  522.344311   Prob > F        =    0.0000
    Residual |  2785600.66   247,186  11.2692493   R-squared       =    0.0022
-------------+----------------------------------   Adj R-squared   =    0.0022
       Total |   2791868.8   247,198   11.294059   Root MSE        =     3.357

------------------------------------------------------------------------------
        EDUC | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
       QOB_1 |  -.1710276   .0192133    -8.90   0.000    -.2086851   -.1333701
       QOB_2 |  -.1301689   .0193444    -6.73   0.000    -.1680834   -.0922544
       QOB_3 |  -.0182944   .0191042    -0.96   0.338    -.0557381    .0191493
        YR20 |  -.5170967   .0304874   -16.96   0.000    -.5768512   -.4573422
        YR21 |  -.3700995   .0300904   -12.30   0.000    -.4290759    -.311123
        YR22 |  -.3728747   .0303102   -12.30   0.000    -.4322818   -.3134676
        YR23 |  -.2737925   .0302848    -9.04   0.000    -.3331499   -.2144351
        YR24 |  -.2140572   .0299223    -7.15   0.000    -.2727042   -.1554102
        YR25 |  -.2288959   .0301342    -7.60   0.000    -.2879581   -.1698337
        YR26 |  -.1415885   .0302578    -4.68   0.000     -.200893    -.082284
        YR27 |  -.1870453   .0298934    -6.26   0.000    -.2456356   -.1284551
        YR28 |  -.1040737   .0302015    -3.45   0.001    -.1632679   -.0448796
       _cons |   11.81295   .0243735   484.66   0.000     11.76518    11.86072
------------------------------------------------------------------------------

. 
. *Create new variable p_educ with the option to contain the linear prediction
. predict p_educ, xb      

. 
. *Create new variable with the birthyear and the birth quarter attached to it   
. gen YQOB=YOB*10+QOB             

. 
. *For every YQOB we attach the predicted mean value of education 
. bysort YQOB: egen m_p_educ=mean(p_educ)

. 
. *-->e.g. if you are born in the first quarter of 1920 --> prediced value is 11.12483
. 
. *Model graph of Year/Quarter of Birth and predicted education --> Figure 1-3 in Paper, but different Years       
>                                                        
. twoway line m_p_educ YQOB

. 
. 
. *** ii. REDUCED FORM: Effect of Z on Y
. 
. *Again: Regress, predict values (here wages) and then attached predicted values to new column by YQOB
. reg LWKLYWGE QOB_1-QOB_3 YR20-YR28

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(12, 247186)   =      6.59
       Model |  33.5480632        12  2.79567193   Prob > F        =    0.0000
    Residual |  104819.472   247,186  .424051005   R-squared       =    0.0003
-------------+----------------------------------   Adj R-squared   =    0.0003
       Total |   104853.02   247,198  .424166133   Root MSE        =    .65119

------------------------------------------------------------------------------
    LWKLYWGE | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
       QOB_1 |  -.0091551    .003727    -2.46   0.014    -.0164599   -.0018502
       QOB_2 |  -.0049948   .0037525    -1.33   0.183    -.0123496    .0023599
       QOB_3 |   .0037528   .0037059     1.01   0.311    -.0035106    .0110162
        YR20 |  -.0180662    .005914    -3.05   0.002    -.0296574   -.0064749
        YR21 |  -.0007022    .005837    -0.12   0.904    -.0121426    .0107382
        YR22 |  -.0066877   .0058796    -1.14   0.255    -.0182116    .0048362
        YR23 |     .00357   .0058747     0.61   0.543    -.0079443    .0150842
        YR24 |   .0092366   .0058044     1.59   0.112    -.0021398    .0206131
        YR25 |   .0124405   .0058455     2.13   0.033     .0009835    .0238976
        YR26 |   .0176972   .0058695     3.02   0.003     .0061932    .0292012
        YR27 |   .0120791   .0057988     2.08   0.037     .0007136    .0234445
        YR28 |   .0158547   .0058586     2.71   0.007     .0043721    .0273373
       _cons |   5.153076    .004728  1089.90   0.000     5.143809    5.162343
------------------------------------------------------------------------------

. predict p_lwage, xb

. bysort YQOB: egen m_p_lwage=mean(p_lwage)

. 
. *Model graph of Year/Quarter of Birth and predicted wages --> Figure 5 in Paper, but different Years            
. twoway line m_p_lwage YQOB

. 
. *Let's look at both graph simultaneously
. gr combine educ.gph wage.gph, col(1) iscale(1)

. 
. 
. 
. ****************************************************************************************
. *** 2. OLS & 2SLS
. 
. *** i. OLS --> Endogeneity problem
. reg LWKLYWGE EDUC YR20-YR28 

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(10, 247188)   =   5100.52
       Model |  17934.8419        10  1793.48419   Prob > F        =    0.0000
    Residual |  86918.1779   247,188  .351627821   R-squared       =    0.1710
-------------+----------------------------------   Adj R-squared   =    0.1710
       Total |   104853.02   247,198  .424166133   Root MSE        =    .59298

------------------------------------------------------------------------------
    LWKLYWGE | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
        EDUC |   .0801595   .0003552   225.67   0.000     .0794633    .0808557
        YR20 |    .023484   .0053878     4.36   0.000     .0129241    .0340439
        YR21 |     .02899   .0053167     5.45   0.000     .0185693    .0394107
        YR22 |   .0232415   .0053556     4.34   0.000     .0127447    .0337383
        YR23 |   .0255564   .0053503     4.78   0.000     .0150699    .0360429
        YR24 |   .0264291    .005286     5.00   0.000     .0160686    .0367896
        YR25 |   .0308406   .0053234     5.79   0.000     .0204069    .0412743
        YR26 |   .0291043   .0053449     5.45   0.000     .0186284    .0395802
        YR27 |   .0271039   .0052807     5.13   0.000     .0167538     .037454
        YR28 |   .0242569   .0053348     4.55   0.000     .0138009     .034713
       _cons |    4.20996   .0056167   749.54   0.000     4.198951    4.220968
------------------------------------------------------------------------------

. 
. *** ii. 2SLS with instrumented education by QOB_1 and store coefficient of Education as iv1
. ivregress 2sls LWKLYWGE (EDUC = QOB_1) YR20-YR28

Instrumental variables 2SLS regression            Number of obs   =    247,199
                                                  Wald chi2(10)   =      88.42
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1694
                                                  Root MSE        =     .59354

------------------------------------------------------------------------------
    LWKLYWGE | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        EDUC |   .0723783   .0225521     3.21   0.001     .0281771    .1165796
        YR20 |   .0194234   .0129442     1.50   0.133    -.0059467    .0447935
        YR21 |   .0260931   .0099399     2.63   0.009     .0066113    .0455749
        YR22 |    .020331   .0099938     2.03   0.042     .0007435    .0399186
        YR23 |   .0234078   .0082128     2.85   0.004     .0073111    .0395045
        YR24 |   .0247518   .0071849     3.44   0.001     .0106697    .0388339
        YR25 |   .0290441   .0074496     3.90   0.000     .0144432     .043645
        YR26 |   .0279904   .0062485     4.48   0.000     .0157436    .0402371
        YR27 |   .0256377   .0067818     3.78   0.000     .0123457    .0389297
        YR28 |   .0234274    .005856     4.00   0.000     .0119499    .0349049
       _cons |   4.301269   .2646696    16.25   0.000     3.782526    4.820012
------------------------------------------------------------------------------
Instrumented: EDUC
 Instruments: YR20 YR21 YR22 YR23 YR24 YR25 YR26 YR27 YR28 QOB_1

. scalar iv1=_b[EDUC]

. 
. *First stage --> Store coefficient
. reg EDUC QOB_1 YR20-YR28

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(10, 247188)   =     50.25
       Model |  5663.52705        10  566.352705   Prob > F        =    0.0000
    Residual |  2786205.27   247,188  11.2716041   R-squared       =    0.0020
-------------+----------------------------------   Adj R-squared   =    0.0020
       Total |   2791868.8   247,198   11.294059   Root MSE        =    3.3573

------------------------------------------------------------------------------
        EDUC | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
       QOB_1 |  -.1217249   .0155276    -7.84   0.000    -.1521587   -.0912912
        YR20 |  -.5182341   .0304897   -17.00   0.000    -.5779931    -.458475
        YR21 |  -.3710116   .0300933   -12.33   0.000    -.4299936   -.3120296
        YR22 |  -.3728217   .0303131   -12.30   0.000    -.4322345   -.3134089
        YR23 |  -.2747318   .0302877    -9.07   0.000    -.3340948   -.2153688
        YR24 |  -.2145555   .0299254    -7.17   0.000    -.2732084   -.1559026
        YR25 |  -.2291913    .030137    -7.60   0.000    -.2882591   -.1701235
        YR26 |  -.1421007   .0302605    -4.70   0.000    -.2014105   -.0827908
        YR27 |   -.186928   .0298964    -6.25   0.000    -.2455241    -.128332
        YR28 |  -.1048829   .0302043    -3.47   0.001    -.1640826   -.0456833
       _cons |   11.76414   .0216421   543.58   0.000     11.72172    11.80656
------------------------------------------------------------------------------

. scalar fs=_b[QOB_1]

. 
. *Reduced Form --> Store coefficient
. reg LWKLYWGE QOB_1 YR20-YR28

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(10, 247188)   =      7.35
       Model |  31.1485464        10  3.11485464   Prob > F        =    0.0000
    Residual |  104821.871   247,188  .424057281   R-squared       =    0.0003
-------------+----------------------------------   Adj R-squared   =    0.0003
       Total |   104853.02   247,198  .424166133   Root MSE        =     .6512

------------------------------------------------------------------------------
    LWKLYWGE | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
       QOB_1 |  -.0088102   .0030118    -2.93   0.003    -.0147133   -.0029072
        YR20 |  -.0180855   .0059139    -3.06   0.002    -.0296766   -.0064944
        YR21 |  -.0007601    .005837    -0.13   0.896    -.0122005    .0106802
        YR22 |  -.0066532   .0058796    -1.13   0.258    -.0181771    .0048707
        YR23 |   .0035232   .0058747     0.60   0.549    -.0079911    .0150374
        YR24 |   .0092226   .0058044     1.59   0.112    -.0021539    .0205991
        YR25 |   .0124556   .0058455     2.13   0.033     .0009987    .0239126
        YR26 |   .0177054   .0058694     3.02   0.003     .0062014    .0292093
        YR27 |   .0121082   .0057988     2.09   0.037     .0007427    .0234737
        YR28 |   .0158362   .0058585     2.70   0.007     .0043536    .0273187
       _cons |   5.152738   .0041978  1227.49   0.000     5.144511    5.160966
------------------------------------------------------------------------------

. scalar rf=_b[QOB_1]

. 
. scalar iv2=rf/fs

. scalar list
       iv2 =  .07237833
        rf = -.00881025
        fs = -.12172493
       iv1 =  .07237833

. 
. *IV estimator is exactly the same as = reduced form/first stage
. *IV gives us the LATE - so the effect on the group that is actually influenced by our treatment
. 
. 
. 
. 
. 
. **************************************************************************************************************
. *** 3. TESTS
. 
. *** i. weak instruments --> Is instrument relevant? --> corr(X,Z)≠0
. *Test F-statistic of the first stage regression of the instrumental variable
. reg EDUC QOB_1 YR20-YR28

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(10, 247188)   =     50.25
       Model |  5663.52705        10  566.352705   Prob > F        =    0.0000
    Residual |  2786205.27   247,188  11.2716041   R-squared       =    0.0020
-------------+----------------------------------   Adj R-squared   =    0.0020
       Total |   2791868.8   247,198   11.294059   Root MSE        =    3.3573

------------------------------------------------------------------------------
        EDUC | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
       QOB_1 |  -.1217249   .0155276    -7.84   0.000    -.1521587   -.0912912
        YR20 |  -.5182341   .0304897   -17.00   0.000    -.5779931    -.458475
        YR21 |  -.3710116   .0300933   -12.33   0.000    -.4299936   -.3120296
        YR22 |  -.3728217   .0303131   -12.30   0.000    -.4322345   -.3134089
        YR23 |  -.2747318   .0302877    -9.07   0.000    -.3340948   -.2153688
        YR24 |  -.2145555   .0299254    -7.17   0.000    -.2732084   -.1559026
        YR25 |  -.2291913    .030137    -7.60   0.000    -.2882591   -.1701235
        YR26 |  -.1421007   .0302605    -4.70   0.000    -.2014105   -.0827908
        YR27 |   -.186928   .0298964    -6.25   0.000    -.2455241    -.128332
        YR28 |  -.1048829   .0302043    -3.47   0.001    -.1640826   -.0456833
       _cons |   11.76414   .0216421   543.58   0.000     11.72172    11.80656
------------------------------------------------------------------------------

. test QOB_1

 ( 1)  QOB_1 = 0

       F(  1,247188) =   61.45
            Prob > F =    0.0000

. 
. *--> Critical Value: 10 --> here: 61.45 --> Not a weak instrument
. 
. *** ii. endogeneity --> Is instrument exogeneous? --> corr(Z,u)=0?
. ***J Test of overidentification --> need more Z´s than X´s
. 
end of do-file

. do "C:\Users\Max\AppData\Local\Temp\STD3280_000000.tmp"

. ivregress 2sls LWKLYWGE (EDUC = QOB_1-QOB_3)YR20-YR28

Instrumental variables 2SLS regression            Number of obs   =    247,199
                                                  Wald chi2(10)   =      92.24
                                                  Prob > chi2     =     0.0000
                                                  R-squared       =     0.1635
                                                  Root MSE        =     .59565

------------------------------------------------------------------------------
    LWKLYWGE | Coefficient  Std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
        EDUC |   .0633511   .0165376     3.83   0.000      .030938    .0957642
        YR20 |   .0147126    .010185     1.44   0.149    -.0052496    .0346747
        YR21 |   .0227322   .0081495     2.79   0.005     .0067595    .0387049
        YR22 |   .0169544   .0081968     2.07   0.039      .000889    .0330198
        YR23 |   .0209151   .0070518     2.97   0.003     .0070939    .0347363
        YR24 |   .0228058   .0063951     3.57   0.000     .0102718    .0353399
        YR25 |   .0269599   .0065701     4.10   0.000     .0140828     .039837
        YR26 |    .026698   .0058675     4.55   0.000     .0151978    .0381982
        YR27 |   .0239367   .0061517     3.89   0.000     .0118797    .0359938
        YR28 |   .0224651   .0056412     3.98   0.000     .0114085    .0335216
       _cons |   4.407202   .1941013    22.71   0.000      4.02677    4.787633
------------------------------------------------------------------------------
Instrumented: EDUC
 Instruments: YR20 YR21 YR22 YR23 YR24 YR25 YR26 YR27 YR28 QOB_1 QOB_2 QOB_3

. 
end of do-file

. do "C:\Users\Max\AppData\Local\Temp\STD3280_000000.tmp"

. predict resid, residuals

. 
end of do-file

. do "C:\Users\Max\AppData\Local\Temp\STD3280_000000.tmp"

. regress resid QOB_1-QOB_3 YR20-YR28

      Source |       SS           df       MS      Number of obs   =   247,199
-------------+----------------------------------   F(12, 247186)   =      0.19
       Model |  .821736221        12  .068478018   Prob > F        =    0.9987
    Residual |  87704.7142   247,186  .354812628   R-squared       =    0.0000
-------------+----------------------------------   Adj R-squared   =   -0.0000
       Total |   87705.536   247,198  .354798728   Root MSE        =    .59566

------------------------------------------------------------------------------
       resid | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
       QOB_1 |   .0016797   .0034092     0.49   0.622    -.0050022    .0083617
       QOB_2 |   .0032515   .0034325     0.95   0.344    -.0034761    .0099791
       QOB_3 |   .0049118   .0033898     1.45   0.147    -.0017322    .0115558
        YR20 |  -.0000201   .0054097    -0.00   0.997    -.0106229    .0105828
        YR21 |   .0000118   .0053393     0.00   0.998     -.010453    .0104766
        YR22 |  -.0000201   .0053782    -0.00   0.997    -.0105613    .0105211
        YR23 |  -9.98e-08   .0053737    -0.00   1.000    -.0105325    .0105323
        YR24 |  -8.42e-06   .0053094    -0.00   0.999    -.0104148    .0103979
        YR25 |  -.0000186    .005347    -0.00   0.997    -.0104986    .0104614
        YR26 |  -.0000311   .0053689    -0.01   0.995    -.0105541    .0104919
        YR27 |  -8.16e-06   .0053043    -0.00   0.999    -.0104044    .0103881
        YR28 |  -.0000172    .005359    -0.00   0.997    -.0105206    .0104863
       _cons |  -.0024888   .0043248    -0.58   0.565    -.0109653    .0059878
------------------------------------------------------------------------------

. 
end of do-file

. do "C:\Users\Max\AppData\Local\Temp\STD3280_000000.tmp"

. scalar test=e(r2)*e(N) //number of observations times R2

. 
end of do-file

. do "C:\Users\Max\AppData\Local\Temp\STD3280_000000.tmp"

. scalar list test 
      test =  2.3160724

. 
end of do-file

. exit, clear
